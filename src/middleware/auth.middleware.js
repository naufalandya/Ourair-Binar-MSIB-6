"use strict";

// middlewares/auth.middleware.js
const passport = require("passport");
const GoogleStrategy = require("passport-google-oauth20").Strategy;
const jwt = require("jsonwebtoken");
const { PrismaClient } = require("@prisma/client");
require("dotenv").config();

const prisma = new PrismaClient();

// passport.use(
//   new GoogleStrategy(
//     {
//       clientID: process.env.GOOGLE_CLIENT_ID,
//       clientSecret: process.env.GOOGLE_CLIENT_SECRET,
//       callbackURL: process.env.GOOGLE_CALLBACK_URL,
//     },
//     async (accessToken, refreshToken, profile, done) => {
//       
//       let user = await prisma.users.findUnique({
//         where: { googleId: profile.id },
//       });

//       if (!user) {
//         user = await prisma.users.create({
//           data: {
//             googleId: profile.id,
//             email: profile.emails[0].value,
//             name: profile.displayName,
//           },
//         });
//       }

//       const token = jwt.sign({ id: user.id }, process.env.JWT_SECRET, {
//         expiresIn: "23h",
//       });
//       return done(null, { user, token });
//     }
//   )
// );

// passport.serializeUser((data, done) => {
//   done(null, data);
// });

// passport.deserializeUser((data, done) => {
//   done(null, data);
// });

const verifyToken1 = (req, res, next) => {
  const token = req.headers["authorization"];
  // const token = req.cookies;
  if (!token) {
    return res.status(401).send("Access Denied");
  }

  try {
    const verified = jwt.verify(token, process.env.JWT_SECRET);
    ;
    req.user = verified;
    next();
  } catch (err) {
    res.status(400).send("Invalid Token");
  }
};

// try {
//   const verified = jwt.verify(token, process.env.JWT_SECRET);
//   ;
//   req.user = await prisma.users.findUnique({ where: { id: verified.id } });
//   next();
// } catch (err) {
//   res.status(400).send("Invalid Token");
// }
module.exports = {
  verifyToken1,
  passport,
};
